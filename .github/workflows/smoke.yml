name: Smoke Test CI

on:
  push:
    branches: [ main ] # Or your default branch name
  pull_request:
    branches: [ main ] # Or your default branch name

jobs:
  lint:
    name: Linters
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Homebrew (Linux)
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install Dependencies
        run: |
          brew install chezmoi
          pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files

      - name: Run chezmoi verify
        run: chezmoi verify .

  build:
    name: Build (Ubuntu)
    runs-on: ubuntu-latest
    needs: [lint] # Run after linters pass
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Homebrew (Linux)
        uses: Homebrew/actions/setup-homebrew@master

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: /home/linuxbrew/.cache/Homebrew
          key: ${{ runner.os }}-brew-${{ hashFiles('**/Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Install Dependencies
        # Install chezmoi, mise, fish, and any deps needed *before* chezmoi apply
        run: |
          brew install chezmoi neovim fish

      - name: Setup mise
        uses: nick-fields/setup-mise@v0

      - name: Run chezmoi apply
        # Use -v for verbose output, useful for debugging CI failures
        run: chezmoi apply -v

      - name: Test fish shell initialization
        run: |
          # Test that fish shell loads and configuration works
          timeout 10s fish -c '
            # Check if fish configuration loaded
            if test -n "$fish_greeting"
              echo "✅ Fish configuration loaded successfully"
            else
              echo "❌ Fish configuration failed to load"
              exit 1
            end

            # Test that fish functions are available
            if functions -q fish_prompt
              echo "✅ Fish prompt function available"
            else
              echo "❌ Fish prompt function not found"
              exit 1
            end
          '
