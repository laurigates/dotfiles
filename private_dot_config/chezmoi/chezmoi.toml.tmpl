{{- /* Profile selection â€” core always installs; others are opt-in */}}
{{- $p_dev       := promptBoolOnce . "profiles.dev"       "Install dev CLI tools (ast-grep, httpie, pandoc, etc.)?" true -}}
{{- $p_dev_build := promptBoolOnce . "profiles.dev_build" "Install build tools (cmake, ninja, maven)?" false -}}
{{- $p_infra     := promptBoolOnce . "profiles.infra"     "Install K8s/IaC tools (kubectl, helm, terraform)?" true -}}
{{- $p_security  := promptBoolOnce . "profiles.security"  "Install security tools (nmap, wireshark, etc.)?" false -}}
{{- $p_embedded  := promptBoolOnce . "profiles.embedded"  "Install embedded/IoT tools (arduino, platformio)?" false -}}
{{- $p_services  := promptBoolOnce . "profiles.services"  "Install services (postgres, mosquitto, ollama)?" false -}}
{{- $p_media     := promptBoolOnce . "profiles.media"     "Install media tools (ffmpeg, blender)?" false -}}
{{- $p_gui       := promptBoolOnce . "profiles.gui"       "Install GUI apps (casks, MAS apps)?" true -}}

{{- $cpuCores := 4 }}
{{- $cpuThreads := 8 }}
{{- /* CPU detection disabled in CI environments to avoid permission issues */}}
{{- if not (env "CI") }}
{{-   if eq .chezmoi.os "darwin" }}
{{-     $cpuCores = (output "sysctl" "-n" "hw.physicalcpu_max") | trim | atoi }}
{{-     $cpuThreads = (output "sysctl" "-n" "hw.logicalcpu_max") | trim | atoi }}
{{-   else if eq .chezmoi.os "linux" }}
{{-     $cpuCores = (output "sh" "-c" "lscpu --online --parse | grep --invert-match '^#' | sort --field-separator=',' --key='2,4' --unique | wc --lines") | trim | atoi }}
{{-     $cpuThreads = (output "sh" "-c" "lscpu --online --parse | grep --invert-match '^#' | wc --lines") | trim | atoi }}
{{-   else if eq .chezmoi.os "windows" }}
{{-     $cpuCores = (output "powershell.exe" "-NoProfile" "-NonInteractive" "-Command" "(Get-CimInstance -ClassName 'Win32_Processor').NumberOfCores") | trim | atoi }}
{{-     $cpuThreads = (output "powershell.exe" "-NoProfile" "-NonInteractive" "-Command" "(Get-CimInstance -ClassName 'Win32_Processor').NumberOfLogicalProcessors") | trim | atoi }}
{{-   end }}
{{- end }}

# Chezmoi configuration with dynamic CPU detection
sourceDir = {{ .chezmoi.sourceDir | quote }}

[edit]
command = "nvim"

[data]
    # Platform and hardware detection
    [data.cpu]
        cores = {{ $cpuCores }}
        threads = {{ $cpuThreads }}

    # Package management settings
    [data.packages]
        # Enable parallel installations where supported
        parallel_jobs = {{ $cpuThreads }}

        # Homebrew settings
        [data.packages.homebrew]
        {{- if eq .chezmoi.os "darwin" }}
            prefix = "/opt/homebrew"
        {{- else if eq .chezmoi.os "linux" }}
            prefix = "/home/linuxbrew/.linuxbrew"
        {{- end }}

    # Package profiles (core is always on)
    [data.profiles]
        dev       = {{ $p_dev }}
        dev_build = {{ $p_dev_build }}
        infra     = {{ $p_infra }}
        security  = {{ $p_security }}
        embedded  = {{ $p_embedded }}
        services  = {{ $p_services }}
        media     = {{ $p_media }}
        gui       = {{ $p_gui }}

[merge]
    command = "nvim"
    args = [
        "-d",
        {{ printf "%q" "{{ .Destination }}" }},
        {{ printf "%q" "{{ .Source }}" }},
        {{ printf "%q" "{{ .Target }}" }},
    ]

[scriptEnv]
    # Environment variables for scripts
    HOMEBREW_NO_AUTO_UPDATE = "1"
    HOMEBREW_NO_ANALYTICS = "1"
    MISE_EXPERIMENTAL = "1"

    # Parallel build settings
    MAKEFLAGS = "-j{{ $cpuThreads }}"
    NPM_CONFIG_JOBS = "{{ $cpuThreads }}"
