# http://blog.askesis.pl/post/2017/04/how-to-debug-zsh-startup-time.html
# uncomment this and zprof at the end of this file to profile zsh startup
# zmodload zsh/zprof

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.

#emulate sh -c '. /etc/profile'

# Remove "/" from WORDCHARS so that Ctrl+W doesn't kill directory paths.
WORDCHARS="${WORDCHARS//[\/]}"

# Load brew and related completions if it is installed
# Prepend homebrew to path
# Avoid using brew shellenv for setup, because brew completions are messed up
# Handle macos and linux paths for homebrew
{{ if eq .chezmoi.os "darwin" }}
if type /opt/homebrew/bin/brew &> /dev/null; then
  path=("/opt/homebrew/bin" "/opt/homebrew/sbin" $path)
fi
{{ else if eq .chezmoi.os "linux" }}
if type /home/linuxbrew/.linuxbrew/bin/brew &> /dev/null; then
  path=("/home/linuxbrew/.linuxbrew/bin" "/home/linuxbrew/.linuxbrew/sbin" $path)
fi
{{ end }}

eval "$(mise activate zsh)"


#======================================================================
# History Configuration
#======================================================================

setopt extended_history       # record timestamp of command in HISTFILE
setopt hist_expire_dups_first # delete duplicates first when HISTFILE size exceeds HISTSIZE
setopt hist_ignore_dups       # ignore duplicated commands history list
setopt hist_ignore_space      # ignore commands that start with space
setopt hist_verify            # show command with history expansion to user before running it
setopt share_history          # share command history data

## History command wrapper (from Oh My Zsh)
# https://github.com/ohmyzsh/ohmyzsh/blob/master/lib/history.zsh
function omz_history {
  local clear list
  zparseopts -E c=clear l=list

  if [[ -n "$clear" ]]; then
    # if -c provided, clobber the history file
    echo -n >| "$HISTFILE"
    fc -p "$HISTFILE"
    echo >&2 History file deleted.
  elif [[ -n "$list" ]]; then
    # if -l provided, run as if calling `fc' directly
    builtin fc "$@"
  else
    # unless a number is provided, show all history events (starting from 1)
    [[ ${@[-1]-} = *[0-9]* ]] && builtin fc -l "$@" || builtin fc -l "$@" 1
  fi
}

# Timestamp format
case ${HIST_STAMPS-} in
  "mm/dd/yyyy") alias history='omz_history -f' ;;
  "dd.mm.yyyy") alias history='omz_history -E' ;;
  "yyyy-mm-dd") alias history='omz_history -i' ;;
  "") alias history='omz_history' ;;
  *) alias history="omz_history -t '$HIST_STAMPS'" ;;
esac


#======================================================================
# Zsh Options (setopt)
#======================================================================

setopt auto_cd                # change directories without cd
setopt complete_in_word
setopt always_to_end
setopt interactivecomments
setopt multios
setopt prompt_subst
setopt auto_menu
# Extended glob can be problematic with git commands
# Because of HEAD^ etc in commands
setopt extendedglob


#======================================================================
# Completion System Configuration (zstyle)
#======================================================================

# General completion settings
# https://grml.org/zsh/zsh-lovers.html
# Fuzzy matching of completions for when you mistype them:
zstyle ':completion:*' completer _complete _match _approximate
zstyle ':completion:*:match:*' original only
zstyle ':completion:*:approximate:*' max-errors 1 numeric
# cd will never select the parent directory (e.g.: cd ../<TAB>):
zstyle ':completion:*:cd:*' ignore-parents parent pwd
zstyle ':completion:*' file-sort modification

# fzf-tab specific styles
zstyle ':completion:*:git-checkout:*' sort false # disable sort when completing `git checkout`
zstyle ':completion:*:descriptions' format '[%d]' # set descriptions format to enable group support
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS} # set list-colors (needs verification)
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'lsd --depth 1 --color always --tree $realpath' # preview directory content
zstyle ':fzf-tab:*' switch-group ',' '.' # switch group using `,` and `.`
# tldr preview example:
# zstyle ':fzf-tab:complete:tldr:argument-1' fzf-preview 'tldr --color always $word'
# systemd unit status preview (Linux only)
zstyle ':fzf-tab:complete:systemctl-*:*' fzf-preview 'SYSTEMD_COLORS=1 systemctl status $word'
# Git previews
zstyle ':fzf-tab:complete:git-(add|diff|restore):*' fzf-preview \
	'git diff $word | delta'
zstyle ':fzf-tab:complete:git-log:*' fzf-preview \
	'git log --color=always $word'
zstyle ':fzf-tab:complete:git-help:*' fzf-preview \
	'git help $word | bat -plman --color=always'
zstyle ':fzf-tab:complete:git-show:*' fzf-preview \
	'case "$group" in
	"commit tag") git show --color=always $word ;;
	*) git show --color=always $word | delta ;;
	esac'
zstyle ':fzf-tab:complete:git-checkout:*' fzf-preview \
	'case "$group" in
	"modified file") git diff $word | delta ;;
	"recent commit object name") git show --color=always $word | delta ;;
	*) git log --color=always $word ;;
	esac'

# Enable IP addresses in completions (moved from fzf-tab section for clarity)
zstyle ':completion:*' use-ip true


#======================================================================
# Helper Functions & Widgets
#======================================================================

# Rationalise dots for quick directory changes (cd ../<TAB>)
rationalise-dot() {
  if [[ $LBUFFER = *.. ]]; then
    LBUFFER+=/..
  else
    LBUFFER+=.
  fi
}
zle -N rationalise-dot
bindkey . rationalise-dot


#======================================================================
# Plugin Sourcing
#======================================================================

# source "$HOME/.asdf/plugins/golang/set-env.zsh" # Example if needed
# command -v direnv &>/dev/null && eval "$(direnv hook zsh)" # Example if needed
# source "${XDG_CONFIG_HOME:-$HOME/.config}/asdf-direnv/zshrc" &>/dev/null
# autoload -Uz zkbd # Load zkbd module (used for keybindings below, if uncommented)

## Plugins (Load before zsh-vi-mode if they don't depend on its bindings)
source ~/zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.plugin.zsh
# fzf-tab doesn't seem to work for brew completions e.g. kubectl
source ~/zsh/fzf-tab/fzf-tab.plugin.zsh
source ~/zsh/zsh-autosuggestions/zsh-autosuggestions.plugin.zsh


#======================================================================
# FZF Configuration
#======================================================================

# Source fzf keybindings and completions
source <(fzf --zsh)


#======================================================================
# Aliases
#======================================================================

# Load aliases after plugins so that conditional aliases for executables managed
# by asdf can be found and aliased correctly.
source ~/aliases.zsh


#======================================================================
# Environment Variables & Path
#======================================================================

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"


#======================================================================
# Tool Initializations (Starship, Zoxide, Atuin, etc.)
#======================================================================

eval "$(starship init zsh)"
eval "$(zoxide init zsh)"
eval "$(atuin init zsh)"

{{ if eq .chezmoi.os "darwin" }}
# OrbStack (macOS only)
eval "$(orbctl completion zsh)"
eval "$(orb completion zsh)"
{{ end }}


#======================================================================
# Completion System Initialization
#======================================================================

# Add custom completion directory to fpath (if not already added above)
# NOTE: This needs to be before compinit
# fpath+=~/.zfunc # This is already added in the Plugin Sourcing section

# Load Homebrew specific completions (if available)
# Needs to be before compinit if they add to fpath or define functions compinit should know
{{ if eq .chezmoi.os "darwin" }}
if type /opt/homebrew/bin/brew &> /dev/null; then
    # google-cloud-sdk path and completions
    # Ensure these are sourced before compinit if they modify fpath or define completion functions
    [ -f "$(brew --prefix)/share/google-cloud-sdk/path.zsh.inc" ] && \
      source "$(brew --prefix)/share/google-cloud-sdk/path.zsh.inc"
    [ -f "$(brew --prefix)/share/google-cloud-sdk/completion.zsh.inc" ] && \
      source "$(brew --prefix)/share/google-cloud-sdk/completion.zsh.inc"
fi
{{ else if eq .chezmoi.os "linux" }}
if type /home/linuxbrew/.linuxbrew/bin/brew &> /dev/null; then
    # Add Linux paths for brew completions if needed
    # Example:
    # [ -f "$(brew --prefix)/share/google-cloud-sdk/path.zsh.inc" ] && \
    #   source "$(brew --prefix)/share/google-cloud-sdk/path.zsh.inc"
    # [ -f "$(brew --prefix)/share/google-cloud-sdk/completion.zsh.inc" ] && \
    #   source "$(brew --prefix)/share/google-cloud-sdk/completion.zsh.inc"
    : # Placeholder if no specific Linux brew completions needed here yet
fi
{{ end }}

# bun completions
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# Initialize the completion system
autoload -Uz compinit && compinit

# Load completions that must run *after* compinit

# Completion for kitty
# https://sw.kovidgoyal.net/kitty/index.html#configuring-kitty
if type kitty &> /dev/null; then
    kitty +complete setup zsh | source /dev/stdin
fi

# Load Homebrew bash completions (if available)
# Requires bashcompinit to be loaded after compinit
if type brew &> /dev/null; then
    # Enable loading bash completions
    autoload -U +X bashcompinit && bashcompinit

    # Load specific bash completions provided by brew packages
    # Example: Terraform completions
    if [ -x "$(brew --prefix)/bin/terraform" ]; then
      complete -o nospace -C "$(brew --prefix)/bin/terraform" terraform
    fi
    # Add other bash completions here if needed
fi


#======================================================================
# Keybindings
#======================================================================

# Unbind problematic bindings
# bindkey -r "^[" # Example: Unbind Alt key if needed

# Alt+c for fzf-cd-widget (Note: 'ç' might be specific to your keyboard layout for Alt+c)
bindkey "ç" fzf-cd-widget

# Add a PC-like bind for pipe on macos (Command + <)
# This sequence "^[[60;9u" might be specific to your terminal/setup
bindkey -s "^[[60;9u" "|"

# Example zkbd usage (uncomment and configure if needed)
# source ~/.zkbd/$TERM-${${DISPLAY:t}:-$VENDOR-$OSTYPE}
# [[ -n ${key[Left]} ]] && bindkey "${key[Left]}" backward-char
# [[ -n ${key[Right]} ]] && bindkey "${key[Right]}" forward-char


#======================================================================
# Profiling (Optional)
#======================================================================
# zprof # Uncomment this if zmodload zsh/zprof is uncommented at the top
