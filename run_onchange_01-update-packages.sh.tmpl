#!/bin/bash
# Update all packages and tools
# Runs when data files change
# Hash: {{ include ".chezmoidata.toml" | sha256sum }}-{{ include ".chezmoidata/packages.toml" | sha256sum }}-{{ include ".chezmoidata/uv_tools.toml" | sha256sum }}

set -euo pipefail

echo "ğŸ”„ Starting comprehensive update process..."

# Brew
{{- if eq .chezmoi.os "darwin" }}
echo "ğŸ“¦ Updating Homebrew packages..."
if [ "${BUMP:-}" = "1" ]; then
    echo "ğŸš€ Full upgrade including casks..."
    brew update && brew upgrade && brew upgrade --cask && brew cleanup
else
    brew update && brew upgrade && brew cleanup
fi
{{- else }}
echo "ğŸ“¦ Updating Homebrew packages..."
if [ "${BUMP:-}" = "1" ]; then
    echo "ğŸš€ Full upgrade including casks..."
    /home/linuxbrew/.linuxbrew/bin/brew update && /home/linuxbrew/.linuxbrew/bin/brew upgrade && /home/linuxbrew/.linuxbrew/bin/brew upgrade --cask && /home/linuxbrew/.linuxbrew/bin/brew cleanup
else
    /home/linuxbrew/.linuxbrew/bin/brew update && /home/linuxbrew/.linuxbrew/bin/brew upgrade && /home/linuxbrew/.linuxbrew/bin/brew cleanup
fi
{{- end }}

# mise
if command -v mise >/dev/null 2>&1; then
    echo "ğŸ› ï¸  Updating mise and tool versions..."
    if [ "${BUMP:-}" = "1" ]; then
        echo "ğŸš€ Bumping to latest versions and updating global config..."
        mise upgrade --bump
        echo "ğŸ“ Updating global mise config with new versions..."
        # Update global config to reflect new versions
        mise list --current | while read -r tool version; do
            [ -n "$tool" ] && [ -n "$version" ] && mise use --global "${tool}@${version}"
        done
    else
        mise upgrade
    fi
else
    echo "âš ï¸  mise not found, skipping tool updates"
fi

# Neovim
if command -v nvim >/dev/null 2>&1; then
    echo "âš™ï¸  Updating Neovim plugins and LSP tools..."
    nvim --headless "+Lazy! sync" "+lua require('lazy').load({plugins={'mason.nvim'}})" "+MasonUpdate" +qa
else
    echo "âš ï¸  Neovim not found, skipping plugin updates"
fi

# uv tools
if command -v uv >/dev/null 2>&1; then
    echo "ğŸ Installing and updating Python tools via uv..."
    {{- range .packages.uv_tools.tools }}
    if ! uv tool list | grep -q "^{{ . }} "; then
        echo "ğŸ“¦ Installing {{ . }}..."
        uv tool install {{ . }} --force
    else
        echo "âœ… {{ . }} already installed"
    fi
    {{- end }}

    {{- if .packages.uv_tools.git_tools }}
    echo "ğŸ”§ Installing Git-based tools..."
    {{- range .packages.uv_tools.git_tools }}
    if ! uv tool list | grep -q "^{{ .package }} "; then
        echo "ğŸ“¦ Installing {{ .package }} from {{ .url }}..."
        {{- if hasKey . "with" }}
        uv tool install "{{ .url }}" --force --with {{ range $i, $dep := .with }}{{ if $i }},{{ end }}{{ $dep }}{{ end }}
        {{- else }}
        uv tool install "{{ .url }}" --force
        {{- end }}
    else
        echo "âœ… {{ .package }} already installed"
    fi
    {{- end }}
    {{- end }}

    if [ "${BUMP:-}" = "1" ]; then
        echo "ğŸš€ Upgrading all uv tool packages to latest versions..."
    else
        echo "â¬†ï¸  Upgrading all uv tool packages..."
    fi
    uv tool upgrade --all
else
    echo "âš ï¸  uv not found, skipping Python package updates"
fi

echo "âœ… Update process completed successfully!"
